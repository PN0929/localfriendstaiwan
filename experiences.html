<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Experiences - Local Friends Taiwan | å°ç£åœ¨åœ°é€£ç·š</title>
  <meta name="description" content="Browse authentic local experiences in Taiwan. Connect with real Taiwanese locals.">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft JhengHei",sans-serif;line-height:1.6;color:#2D6A4F;background:#F7F5F2}

    /* æµ®å‹•å°è¦½åˆ— */
    .floating-nav{
      position:fixed;left:20px;top:50%;transform:translateY(-50%);z-index:1000;
      background:#fff;padding:1rem;border-radius:30px;box-shadow:0 4px 20px rgba(45,106,79,.2);border:2px solid #2D6A4F
    }
    .floating-nav a{
      display:block;width:50px;height:50px;margin:.5rem 0;border-radius:50%;
      background:linear-gradient(135deg,#2D6A4F,#40916C);color:#fff;text-decoration:none;
      display:flex;align-items:center;justify-content:center;font-size:1.5rem;transition:.3s
    }
    .floating-nav a:hover{transform:scale(1.1);background:linear-gradient(135deg,#40916C,#52B788)}

    /* å›é ‚æŒ‰éˆ• */
    .back-to-top{
      position:fixed;right:30px;bottom:30px;width:60px;height:60px;background:linear-gradient(135deg,#F4845F,#F4A261);
      color:#fff;border:none;border-radius:50%;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 20px rgba(244,132,95,.4);
      display:none;z-index:999;transition:.3s
    }
    .back-to-top:hover{transform:translateY(-5px)}
    .back-to-top.show{display:flex;align-items:center;justify-content:center}

    /* Hero + ç¸®å°ç‹€æ…‹ */
    .header{
      position:relative;
      background:linear-gradient(rgba(45,106,79,.75),rgba(45,106,79,.75)),url('images/hero.jpg');
      background-size:cover;background-position:center;background-attachment:fixed;
      color:#fff;text-align:center;
      padding:5rem 2rem; /* å¤§ç‰ˆé¢ */
      transition:all .35s ease;
      z-index:900;
    }
    .header-inner{max-width:1200px;margin:0 auto}
    .header h1{
      font-size:3rem;font-weight:800;margin-bottom:.5rem;
      text-shadow:2px 2px 6px rgba(0,0,0,.35);letter-spacing:.3px
    }
    .header .subtitle{
      font-size:1.5rem;opacity:.95;text-shadow:1px 2px 4px rgba(0,0,0,.35)
    }

    /* ç¸®å°å¾Œï¼šé»é ‚ã€ä¸€è¡Œæ¨™é¡Œ */
    .header.shrink{
      padding:.6rem 2rem;
      background:linear-gradient(135deg,#2D6A4F,#40916C);
      background-attachment:initial;
      position:sticky; top:0;
      box-shadow:0 6px 18px rgba(0,0,0,.18);
    }
    .header .titles-large{opacity:1;transform:translateY(0);transition:opacity .25s ease, transform .25s ease}
    .header.shrink .titles-large{opacity:0;transform:translateY(-6px);pointer-events:none;height:0;overflow:hidden}

    .header .title-compact{
      display:none;color:#fff;font-weight:800;letter-spacing:.2px;
      text-shadow:0 2px 8px rgba(0,0,0,.3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    .header.shrink .title-compact{display:block;font-size:1.05rem}

    /* ç‰ˆå¿ƒèˆ‡å€å¡Šï¼ˆèˆ‡è©³æƒ…é å°é½Šï¼‰ */
    .container{max-width:1200px;margin:0 auto;padding:2rem}
    .search-filter-section{
      background:#fff;padding:2.5rem;border-radius:15px;margin-bottom:2rem;
      border:3px solid #E9C46A;box-shadow:0 4px 20px rgba(233,196,106,.2);animation:fadeInUp .8s ease
    }

    /* ç´”æ–‡å­—å…¬å‘Šï¼ˆä¸åŠ æ¡†ï¼‰ */
    .notice-text{
      max-width:1200px;margin:1.5rem auto 0; padding:0 2rem;
      color:#2D6A4F;font-size:1rem;line-height:1.85
    }
    .notice-text strong{font-weight:800}

    .search-box{display:flex;gap:1rem;margin-bottom:2rem;flex-wrap:wrap}
    .search-input{
      flex:1;min-width:250px;padding:1.2rem 1.8rem;font-size:1.1rem;border:2px solid #E9C46A;border-radius:50px;
      outline:none;transition:.3s;background:#F7F5F2
    }
    .search-input:focus{border-color:#2D6A4F;background:#fff;box-shadow:0 0 0 3px rgba(45,106,79,.1)}
    .search-btn{
      padding:1.2rem 3rem;background:linear-gradient(135deg,#F4845F,#F4A261);color:#fff;border:none;border-radius:50px;
      font-size:1.1rem;font-weight:800;cursor:pointer;transition:.3s;box-shadow:0 4px 15px rgba(244,132,95,.3)
    }
    .search-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(244,132,95,.4)}

    .filter-section{margin-top:2rem}
    .filter-section h3{color:#2D6A4F;margin-bottom:1rem;font-size:1.4rem;font-weight:800}
    .filter-group{margin-bottom:1.5rem}
    .filter-group label{display:block;margin-bottom:.8rem;font-weight:700;color:#2D6A4F;font-size:1.1rem}
    .filter-buttons{display:flex;flex-wrap:wrap;gap:.8rem}

    /* å°ç±¤ + å–®è¡Œç­–ç•¥ï¼ˆç•¥æ”¾å¤§ï¼‰ */
    .experience-card .meta{
      display:flex;align-items:center;gap:8px;flex-wrap:nowrap;overflow:hidden
    }
    .experience-card .tag{
      display:inline-flex;align-items:center;white-space:nowrap;
      font-size:0.9rem;font-weight:600;
      padding:0.26rem 0.65rem;border-radius:8px;border:1.5px solid #E9C46A;
      background:#F7F5F2;color:#2D6A4F;flex:0 0 auto
    }
    .experience-card .more-tag{
      display:inline-flex;align-items:center;white-space:nowrap;
      font-size:0.9rem;font-weight:700;padding:0.26rem 0.6rem;border-radius:8px;
      border:1.5px dashed #E9C46A;background:#FFF7E6;color:#2D6A4F;flex:0 0 auto
    }

    .filter-btn{
      padding:.8rem 1.8rem;background:#F7F5F2;border:2px solid #E9C46A;border-radius:25px;cursor:pointer;transition:.3s;
      font-size:1rem;font-weight:600;color:#2D6A4F;position:relative
    }
    .filter-btn .count{font-size:.85rem;opacity:.7;margin-left:.3rem}
    .filter-btn:hover{background:#E9C46A;color:#fff;transform:translateY(-2px);box-shadow:0 4px 10px rgba(233,196,106,.3)}
    .filter-btn.active{background:linear-gradient(135deg,#2D6A4F,#40916C);color:#fff;border-color:#2D6A4F;box-shadow:0 4px 15px rgba(45,106,79,.3)}

    .filter-results{text-align:center;color:#2D6A4F;margin:1.5rem 0;font-size:1.3rem;font-weight:800}
    .loading{text-align:center;padding:4rem;font-size:1.3rem;color:#2D6A4F;font-weight:800}

    /* å¡ç‰‡ */
    .experiences-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:2.5rem;margin-top:2rem}
    .experience-card{
      background:#fff;border-radius:15px;overflow:hidden;border:3px solid #E9C46A;box-shadow:0 4px 15px rgba(233,196,106,.2);
      transition:all .4s cubic-bezier(.4,0,.2,1);cursor:pointer;opacity:0;transform:translateY(30px);
      text-decoration:none;color:inherit;display:block
    }
    .experience-card.visible{opacity:1;transform:translateY(0)}
    .experience-card:hover{transform:translateY(-15px) scale(1.02);box-shadow:0 15px 50px rgba(233,196,106,.5);border-color:#F4845F}

    .experience-card .image{
      width:100%;height:280px;background:linear-gradient(135deg,#2D6A4F,#40916C);
      display:flex;align-items:center;justify-content:center;color:#fff;font-size:4.5rem;overflow:hidden;position:relative
    }
    .experience-card .image img{width:100%;height:100%;object-fit:cover;transition:transform .5s ease}
    .experience-card:hover .image img{transform:scale(1.15)}
    .experience-card .image::after{
      content:'';position:absolute;bottom:0;left:0;right:0;height:50%;background:linear-gradient(transparent,rgba(0,0,0,.4));opacity:0;transition:opacity .3s
    }
    .experience-card:hover .image::after{opacity:1}
    .experience-card .image::before{
      content:'é»æ“ŠæŸ¥çœ‹ Click to View â†’';position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
      color:#fff;font-size:1.1rem;font-weight:800;opacity:0;transition:opacity .3s;text-shadow:2px 2px 4px rgba(0,0,0,.5);z-index:2
    }
    .experience-card:hover .image::before{opacity:1}
    .experience-card .content{padding:2rem}
    .experience-card .title{font-size:1.5rem;font-weight:800;margin-bottom:.5rem;color:#2D6A4F;transition:color .3s}
    .experience-card:hover .title{color:#F4845F}
    .experience-card .subtitle{font-size:1rem;color:#666;margin-bottom:1rem}
    .experience-card .description{color:#555;margin-bottom:1.5rem;line-height:1.7;font-size:1.05rem}

    .footer{background:linear-gradient(135deg,#2D6A4F,#40916C);color:#fff;text-align:center;padding:2rem;margin-top:4rem}
    .footer p{font-size:1.1rem}

    /* å‹•ç•« */
    @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

    /* æ‰‹æ©Ÿé©é…ï¼ˆä¸Šæ–¹åƒ…é¡¯ç¤ºè‹±æ–‡ï¼‰ */
    @media (max-width:768px){
      .floating-nav{left:10px;padding:.5rem}
      .floating-nav a{width:40px;height:40px;font-size:1.2rem;margin:.3rem 0}
      .back-to-top{right:15px;bottom:15px;width:50px;height:50px;font-size:1.2rem}
      .header{padding:3.5rem 1rem}
      .header h1{font-size:2rem}
      .header .subtitle{display:none}           /* æ‰‹æ©Ÿï¼šå¤§æ¨™åªç•™è‹±æ–‡ */
      .header.shrink .title-compact{font-size:1rem}

      .container{padding:1rem}
      .search-filter-section{padding:1.5rem}
      .search-box{flex-direction:column}
      .search-input{width:100%}
      .search-btn{width:100%}
      .experiences-grid{grid-template-columns:1fr;gap:2rem}
      .experience-card .image{height:220px;font-size:3.5rem}
      .experience-card .title{font-size:1.3rem}
      .experience-card .content{padding:1.5rem}

      .experience-card .tag,
      .experience-card .more-tag{
        font-size:0.82rem;padding:0.22rem 0.55rem;border-radius:8px
      }
    }
  </style>
</head>
<body>
  <!-- æµ®å‹•å°è¦½ -->
  <nav class="floating-nav">
    <a href="index.html" title="é¦–é ">ğŸ </a>
    <a href="experiences.html" title="é«”é©—">ğŸŒŸ</a>
    <a href="index.html#about" title="é—œæ–¼">â„¹ï¸</a>
    <a href="index.html#contact" title="è¯çµ¡">âœ‰ï¸</a>
  </nav>

  <!-- å›é ‚æŒ‰éˆ• -->
  <button class="back-to-top" onclick="scrollToTop()">â†‘</button>

  <!-- Hero / Shrink header -->
  <header class="header" id="pageHeader">
    <div class="header-inner">
      <div class="titles-large">
        <h1>Authentic Taiwan Experiences</h1>
        <p class="subtitle">çœŸå¯¦çš„å°ç£é«”é©—</p>
      </div>
      <div class="title-compact" id="compactTitle">
        <span class="compact-en">Authentic Taiwan Experiences</span>
        <span class="compact-sep">ã€€ï½œã€€</span>
        <span class="compact-zh">çœŸå¯¦çš„å°ç£é«”é©—</span>
      </div>
    </div>
  </header>

  <!-- è§€æ¸¬ç¸®æ”¾ç”¨å“¨å…µï¼ˆé¿å…é–ƒå‹•ï¼‰ -->
  <div id="headerSentinel" style="height:1px;"></div>

  <!-- ç´”æ–‡å­—å…¬å‘Šï¼ˆä¸åŠ æ¡†ï¼‰ -->
  <div class="notice-text">
    <p><strong>â„¹ï¸ Independent Information Platform</strong><br>
      We provide curated information and contact details. Please reach out to organizations directly to arrange your visit.
      We can help with translation and booking assistance if needed.<br>
      æˆ‘å€‘æä¾›ç­–å±•è³‡è¨Šèˆ‡è¯çµ¡æ–¹å¼ã€‚è«‹ç›´æ¥è¯ç¹«ä¸»è¾¦å–®ä½å®‰æ’åƒè¨ªã€‚å¦‚éœ€ç¿»è­¯æˆ–é ç´„å”åŠ©ï¼Œæˆ‘å€‘å¯ä»¥å¹«å¿™ã€‚
    </p>
  </div>

  <div class="container">
    <!-- æœå°‹èˆ‡ç¯©é¸å€ -->
    <div class="search-filter-section">
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="ğŸ” æœå°‹é«”é©—åç¨±æˆ–é—œéµå­—... Search experiences...">
        <button class="search-btn" onclick="performSearch()">æœå°‹ Search</button>
      </div>

      <div class="filter-section">
        <h3>ğŸ” ç¯©é¸é«”é©— Filter Experiences</h3>
        <div class="filter-group">
          <label>åœ°å€ Region:</label>
          <div class="filter-buttons" id="regionFilters">
            <button class="filter-btn active" data-type="region" data-value="all" onclick="handleFilterClick('region','all',this)">å…¨éƒ¨ All</button>
          </div>
        </div>
        <div class="filter-group">
          <label>åˆ†é¡ Category:</label>
          <div class="filter-buttons" id="categoryFilters">
            <button class="filter-btn active" data-type="category" data-value="all" onclick="handleFilterClick('category','all',this)">å…¨éƒ¨ All</button>
          </div>
        </div>
      </div>
    </div>

    <div class="filter-results" id="filterResults"></div>
    <div id="loading" class="loading">è¼‰å…¥é«”é©—ä¸­... Loading experiences...</div>
    <div id="experiences" class="experiences-grid"></div>
  </div>

  <footer class="footer">
    <p><strong>Local Friends Taiwan å°ç£åœ¨åœ°é€£ç·š</strong></p>
    <p style="margin-top:1rem;opacity:.9;">Your local friend in Taiwan | ä½ çš„å°ç£åœ¨åœ°æœ‹å‹</p>
  </footer>

  <script>
    const SHEET_ID = '1GD4gg3sGIfX7KGrJkYCL10wzvwZh5FMWQPGd9NVTQyc';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

    const categoryEmojis = {'é£²é£Ÿæ–‡åŒ–':'ğŸœ','ç¤¾å€ç”Ÿæ´»':'ğŸ˜ï¸','å»ºç¯‰è—è¡“':'ğŸ›ï¸','å‚³çµ±å·¥è—':'ğŸ¨','ç’°å¢ƒç”Ÿæ…‹':'ğŸŒ±','è¾²æ‘ç”Ÿæ´»':'ğŸŒ¾','å…¶ä»–':'ğŸ“'};
    const regionEmojis   = {'åŒ—å°ç£':'ğŸ™ï¸','ä¸­å°ç£':'ğŸ”ï¸','å—è‡ºç£':'ğŸŒ´','èŠ±æ±':'ğŸŒŠ','é›¢å³¶':'ğŸï¸'};

    let allExperiences = [];
    let currentFilters = { region:'all', category:'all', searchTerm:'' };

    /* --- ä»¥ IntersectionObserver æ§åˆ¶ç¸®å°ï¼ˆé¿å…é–ƒå‹•ï¼‰ --- */
    const headerEl = document.getElementById('pageHeader');
    const sentinel = document.getElementById('headerSentinel');

    // å–®ä¸€è§€æ¸¬å™¨ + rootMarginï¼šè¶…é 120px æ‰ç®—ã€Œé›¢é–‹ã€â†’ ç¸®å°ï¼›å›åˆ° 0px å…§æ¢å¾©
    const shrinkObserver = new IntersectionObserver((entries)=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          // å“¨å…µåœ¨è¦–å£å…§ï¼ˆå« rootMarginï¼‰ï¼šæ¢å¾©å¤§ç‰ˆ
          headerEl.classList.remove('shrink');
        }else{
          // å“¨å…µé›¢é–‹ï¼ˆè¶…é 120pxï¼‰ï¼šç¸®å°
          headerEl.classList.add('shrink');
        }
      });
    }, {root:null, threshold:0, rootMargin:'-120px 0px 0px 0px'});
    shrinkObserver.observe(sentinel);

    /* æ‰‹æ©Ÿåªé¡¯ç¤ºè‹±æ–‡ï¼ˆcompact è¡Œï¼‰ */
    function syncCompactLanguage(){
      const isMobile = window.matchMedia('(max-width: 768px)').matches;
      const zh = document.querySelector('.compact-zh');
      const sep = document.querySelector('.compact-sep');
      if(!zh || !sep) return;
      if(isMobile){ zh.style.display='none'; sep.style.display='none'; }
      else{ zh.style.display='inline'; sep.style.display='inline'; }
    }
    window.addEventListener('resize', syncCompactLanguage);
    document.addEventListener('DOMContentLoaded', syncCompactLanguage);

    async function loadExperiences(){
      try{
        const response = await fetch(SHEET_URL);
        const csvText = await response.text();
        const rows = parseCSV(csvText);
        const headers = rows[0];
        const data = rows.slice(1);

        // åªä¿ç•™ã€Œå·²ç™¼å¸ƒã€
        allExperiences = data.map(row=>{
          const o={}; headers.forEach((h,i)=>o[h]=row[i]||''); return o;
        }).filter(exp => exp['Status'] === 'å·²ç™¼å¸ƒ');

        createFilterButtons();
        displayExperiences(allExperiences);
      }catch(err){
        console.error('è¼‰å…¥å¤±æ•—:', err);
        document.getElementById('loading').innerHTML = `
          <p style="color:#2D6A4F;">è¼‰å…¥é«”é©—æ™‚ç™¼ç”ŸéŒ¯èª¤ Error loading experiences</p>
          <p style="margin-top:1rem;font-size:1rem;color:#555;">è«‹ç¢ºèª Google Sheets å·²è¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„ä»»ä½•äººéƒ½å¯ä»¥æŸ¥çœ‹ã€</p>`;
      }
    }

    function createFilterButtons(){
      const regions = [...new Set(allExperiences.map(exp=>exp['åœ°å€']).filter(Boolean))];
      const regionContainer = document.getElementById('regionFilters');
      const regionCounts = {};
      allExperiences.forEach(exp=>{ if(exp['åœ°å€']) regionCounts[exp['åœ°å€']] = (regionCounts[exp['åœ°å€']]||0)+1; });
      regions.forEach(region=>{
        const btn = document.createElement('button');
        btn.className='filter-btn'; btn.dataset.type='region'; btn.dataset.value=region;
        btn.innerHTML = `${regionEmojis[region]||'ğŸ“'} ${region} <span class="count">(${regionCounts[region]||0})</span>`;
        btn.onclick = ()=>handleFilterClick('region', region, btn);
        regionContainer.appendChild(btn);
      });

      const categories = [...new Set(allExperiences.map(exp=>exp['ä¸»è¦åˆ†é¡']).filter(Boolean))];
      const categoryContainer = document.getElementById('categoryFilters');
      const categoryCounts = {};
      allExperiences.forEach(exp=>{ if(exp['ä¸»è¦åˆ†é¡']) categoryCounts[exp['ä¸»è¦åˆ†é¡']] = (categoryCounts[exp['ä¸»è¦åˆ†é¡']]||0)+1; });
      categories.forEach(category=>{
        const btn = document.createElement('button');
        btn.className='filter-btn'; btn.dataset.type='category'; btn.dataset.value=category;
        btn.innerHTML = `${categoryEmojis[category]||'ğŸ“'} ${category} <span class="count">(${categoryCounts[category]||0})</span>`;
        btn.onclick = ()=>handleFilterClick('category', category, btn);
        categoryContainer.appendChild(btn);
      });
    }

    function handleFilterClick(type,value,clickedBtn){
      const container = type==='region' ? document.getElementById('regionFilters') : document.getElementById('categoryFilters');
      container.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
      clickedBtn.classList.add('active');
      currentFilters[type]=value;
      filterAndDisplay();
    }

    function performSearch(){
      currentFilters.searchTerm = document.getElementById('searchInput').value.toLowerCase();
      filterAndDisplay();
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('searchInput').addEventListener('keypress', e=>{
        if(e.key==='Enter') performSearch();
      });
    });

    function filterAndDisplay(){
      let filtered = allExperiences;
      if(currentFilters.searchTerm){
        filtered = filtered.filter(exp=>{
          const text = `
            ${exp['é«”é©—åç¨±(ä¸­)']} 
            ${exp['é«”é©—åç¨±(è‹±)']} 
            ${exp['ä¸€å¥è©±æè¿°(ä¸­)']} 
            ${exp['åœ°å€']} 
            ${exp['ä¸»è¦åˆ†é¡']}
          `.toLowerCase();
          return text.includes(currentFilters.searchTerm);
        });
      }
      if(currentFilters.region!=='all')   filtered = filtered.filter(exp=>exp['åœ°å€']===currentFilters.region);
      if(currentFilters.category!=='all') filtered = filtered.filter(exp=>exp['ä¸»è¦åˆ†é¡']===currentFilters.category);

      updateFilterResults(filtered.length);
      displayExperiences(filtered);
    }

    function updateFilterResults(count){
      const div = document.getElementById('filterResults');
      if(currentFilters.region==='all' && currentFilters.category==='all' && !currentFilters.searchTerm){
        div.textContent = '';
      }else{
        div.textContent = `æ‰¾åˆ° ${count} å€‹é«”é©— Found ${count} experiences`;
      }
    }

    function parseCSV(csv){
      const lines = csv.split('\n');
      return lines.map(line=>{
        const values=[]; let cur=''; let inQ=false;
        for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(ch==='"'){ inQ=!inQ; }
          else if(ch===',' && !inQ){ values.push(cur.trim()); cur=''; }
          else{ cur+=ch; }
        }
        values.push(cur.trim());
        return values;
      });
    }

    function displayExperiences(experiences){
      const container = document.getElementById('experiences');
      const loading = document.getElementById('loading');
      loading.style.display='none';
      container.innerHTML='';

      if(experiences.length===0){
        container.innerHTML = `
          <div style="text-align:center;padding:4rem;grid-column:1/-1;">
            <p style="font-size:1.8rem;color:#2D6A4F;font-weight:800;margin-bottom:1rem;">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„é«”é©—</p>
            <p style="color:#555;font-size:1.2rem;">No experiences match your filters</p>
          </div>`;
        return;
      }

      experiences.forEach((exp, idx)=>{
        const card = createExperienceCard(exp);
        card.style.transitionDelay = `${idx*0.1}s`;
        container.appendChild(card);

        // å»ºç«‹å¾Œå£“ç¸®æ¨™ç±¤æˆå–®è¡Œ +N
        setupTagCompression(card);

        setTimeout(()=>card.classList.add('visible'), 100 + idx*100);
      });
    }

    function createExperienceCard(exp){
      const card = document.createElement('a');
      card.className='experience-card';
      card.href=`experience-detail.html?id=${exp['ID']}`;

      const emoji = categoryEmojis[exp['ä¸»è¦åˆ†é¡']] || regionEmojis[exp['åœ°å€']] || 'ğŸ“';
      const hasImage = exp['å¡ç‰‡åœ–ç‰‡'] && exp['å¡ç‰‡åœ–ç‰‡'].trim()!=='';      

      card.innerHTML = `
        <div class="image">
          ${hasImage
            ? `<img src="${exp['å¡ç‰‡åœ–ç‰‡']}" alt="${exp['é«”é©—åç¨±(ä¸­)']}" onerror="this.style.display='none'; this.parentElement.innerHTML='<span style=\\'font-size:4.5rem\\'>${emoji}</span>'">`
            : emoji}
        </div>
        <div class="content">
          <div class="title">${exp['é«”é©—åç¨±(ä¸­)']}</div>
          ${exp['é«”é©—åç¨±(è‹±)'] ? `<div class="subtitle">${exp['é«”é©—åç¨±(è‹±)']}</div>` : ''}
          <div class="description">${exp['ä¸€å¥è©±æè¿°(ä¸­)'] || 'æ·±åº¦æ–‡åŒ–é«”é©—'}</div>
          <div class="meta">
            ${exp['åœ°å€'] ? `<span class="tag">ğŸ“ ${exp['åœ°å€']}</span>` : ''}
            ${exp['ä¸»è¦åˆ†é¡'] ? `<span class="tag">${exp['ä¸»è¦åˆ†é¡']}</span>` : ''}
            ${exp['é›£åº¦'] ? `<span class="tag">â­ ${exp['é›£åº¦']}</span>` : ''}
          </div>
        </div>`;
      return card;
    }

    /* é‡æ¸¬å®¹å™¨å¯¬åº¦ï¼Œå°‡æ”¾ä¸ä¸‹çš„æ¨™ç±¤æ”¶æˆ +N */
    function compressTagsToOneLine(metaEl){
      if(!metaEl) return;
      metaEl.querySelectorAll('.more-tag').forEach(n => n.remove());
      const chips = Array.from(metaEl.querySelectorAll('.tag'));
      if(chips.length === 0) return;

      chips.forEach(ch => { ch.style.display = 'inline-flex'; });

      const available = metaEl.clientWidth;
      let used = 0;
      let visibleCount = 0;
      const reserveMore = 52; // ç¨åŠ å¤§ï¼Œä»¥ç¬¦åˆè¼ƒå¤§çš„å­—èˆ‡ padding

      for(let i=0; i<chips.length; i++){
        const ch = chips[i];
        const w = ch.offsetWidth + 8; // chip å¯¬ + gap (8px)
        if(i < chips.length - 1){
          if(used + w + reserveMore <= available){ used += w; visibleCount++; }
          else{ break; }
        }else{
          if(used + w <= available){ used += w; visibleCount++; }
        }
      }

      if(visibleCount >= chips.length) return;

      const hidden = chips.slice(visibleCount);
      hidden.forEach(ch => ch.style.display = 'none');

      const more = document.createElement('span');
      more.className = 'more-tag';
      more.textContent = `+${hidden.length}`;
      more.title = hidden.map(h => h.textContent.trim()).join('ã€');

      metaEl.appendChild(more);
    }

    function setupTagCompression(cardEl){
      const metaRows = cardEl.querySelectorAll('.meta');
      metaRows.forEach(m => compressTagsToOneLine(m));
    }

    // è¦–çª—å°ºå¯¸æ”¹è®Šæ™‚é‡æ–°è¨ˆç®—æ‰€æœ‰å¡ç‰‡çš„ tag å£“ç¸®
    window.addEventListener('resize', ()=>{
      document.querySelectorAll('.experience-card .meta').forEach(m => compressTagsToOneLine(m));
      syncCompactLanguage();
    });

    /* å›é ‚ */
    function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}) }
    window.addEventListener('scroll', ()=>{
      const b=document.querySelector('.back-to-top');
      if(window.pageYOffset>300) b.classList.add('show'); else b.classList.remove('show');
    });

    window.addEventListener('DOMContentLoaded', ()=>{
      syncCompactLanguage();
      loadExperiences();
    });
  </script>
</body>
</html>
