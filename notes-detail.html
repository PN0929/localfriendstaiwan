<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trail Notes 探路筆記 - Local Friends Taiwan</title>
  <meta name="description" content="Trail Notes - field notes from Local Friends Taiwan: visits, stories behind hosts, travel mindset, and updates.">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --header-height: 56px;
      --max-width: 900px;
      --green: #2D6A4F;
      --bg: #F7F5F2;
      --accent: #F4845F;
      --accent-soft: #E9C46A;
      --border-soft: #E5DECF;
    }

    html, body { overflow-x: hidden; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif;
      line-height: 1.8;
      color: var(--green);
      background: var(--bg);
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
      word-break: keep-all;
      overflow-wrap: anywhere;
    }
    h1, h2, h3 { text-wrap: balance; }
    img, video { max-width: 100%; height: auto; display: block; }

    /* ===== 共用 Header ===== */
    .site-header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: var(--header-height);
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      gap: 1.25rem;
      background: rgba(247,245,242,0.98);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(45,106,79,0.06);
      z-index: 1100;
    }
    .brand {
      display: flex;
      flex-direction: column;
      justify-content: center;
      line-height: 1.2;
    }
    .brand a {
      text-decoration: none;
      color: var(--green);
    }
    .brand-en {
      font-weight: 700;
      letter-spacing: 0.11em;
      font-size: 0.78rem;
    }
    .brand-zh {
      opacity: 0.9;
      font-size: 0.78rem;
    }

    .main-nav {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .main-nav a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      border: 1.4px solid transparent;
      font-size: 0.86rem;
      font-weight: 700;
      color: var(--green);
      text-decoration: none;
      white-space: nowrap;
      transition: all 0.18s;
    }
    .main-nav a span.en { margin-right: 0.18rem; }
    .main-nav a:hover,
    .main-nav a.active {
      border-color: var(--accent-soft);
      background: #FFF7EB;
      box-shadow: 0 2px 8px rgba(233,196,106,.25);
      transform: translateY(-1px);
    }

    .nav-toggle {
      display: none;
      margin-left: auto;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1.4px solid var(--green);
      background: transparent;
      color: var(--green);
      font-size: 1.2rem;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .nav-toggle:hover { background: #E9C46A22; }
    .nav-toggle.open {
      background: var(--green);
      color: #F7F5F2;
      border-color: var(--green);
    }

    @media (max-width: 768px) {
      .site-header {
        padding: 0 1rem;
      }
      .brand-en,
      .brand-zh {
        font-size: 0.74rem;
      }

      .main-nav {
        position: fixed;
        top: var(--header-height);
        left: 0; right: 0;
        padding: 0.45rem 0.85rem 0.55rem;
        background: rgba(247,245,242,0.98);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(45,106,79,0.08);
        display: none;
        flex-wrap: nowrap;
        gap: 0.45rem;
        overflow-x: auto;
        white-space: nowrap;
        z-index: 1090;
      }
      .main-nav.open { display: flex; }
      .main-nav::-webkit-scrollbar { height: 3px; }
      .main-nav::-webkit-scrollbar-thumb {
        background: rgba(233,196,106,0.9);
        border-radius: 999px;
      }
      .main-nav a {
        padding: 0.35rem 0.8rem;
        font-size: 0.8rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      }

      .nav-toggle { display: inline-flex; }
    }

    /* 回頂按鈕 */
    .back-to-top {
      position: fixed;
      right: 30px;
      bottom: 30px;
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #F4845F, #F4A261);
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 1.5rem;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(244,132,95,0.4);
      display: none;
      z-index: 1000;
      transition: transform 0.3s;
    }
    .back-to-top:hover { transform: translateY(-5px); }
    .back-to-top.show {
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeInUp 0.5s ease;
    }

    /* Hero for Note Detail */
    .hero-note {
      padding: calc(3.2rem + var(--header-height)) 1.5rem 1.8rem;
      background: #ffffff;
      border-bottom: 1px solid rgba(0,0,0,0.04);
      color: var(--green);
    }
    .hero-inner {
      max-width: var(--max-width);
      margin: 0 auto;
    }
    .hero-kicker {
      font-size: 0.78rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #8d8d8d;
      margin-bottom: 0.35rem;
    }
    .hero-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.2rem;
      line-height: 1.35;
    }
    .hero-subtitle-zh {
      font-size: 0.9rem;
      color: #7a8b80;
      margin-bottom: 0.3rem;
    }
    .hero-meta {
      font-size: 0.88rem;
      color: #7a8b80;
      margin-bottom: 0.2rem;
    }
    .hero-back {
      font-size: 0.86rem;
      margin-top: 0.2rem;
    }
    .hero-back a {
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px solid rgba(244,132,95,0.4);
      padding-bottom: 1px;
    }
    .hero-back a:hover {
      color: var(--green);
      border-color: var(--green);
    }

    /* Note content wrapper */
    .note-wrapper {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 2rem 1.5rem 3rem;
    }
    .note-card {
      background: #ffffff;
      border-radius: 14px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 4px 14px rgba(0,0,0,0.03);
      padding: 1.6rem 1.5rem 1.8rem;
    }

    .note-cover {
      margin: -1.6rem -1.5rem 1.2rem;
      border-radius: 14px 14px 0 0;
      overflow: hidden;
      max-height: 340px;
    }
    .note-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .note-badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.4rem;
    }
    .note-badge {
      padding: 0.16rem 0.6rem;
      font-size: 0.75rem;
      border-radius: 999px;
      background: #F7F5F2;
      border: 1px solid #E9C46A;
      color: #566;
    }

    .note-content {
      font-size: 0.98rem;
      color: #444;
      margin-top: 0.4rem;
    }
    .note-error {
      font-size: 0.95rem;
      color: #777;
      text-align: center;
      padding: 1.4rem 0 0;
    }

    /* Content inside fetched doc */
    .note-content h1,
    .note-content h2,
    .note-content h3,
    .note-content h4 {
      color: var(--green);
      margin: 1.1rem 0 0.4rem;
      font-weight: 700;
      line-height: 1.4;
    }
    .note-content p {
      margin: 0.5rem 0;
      color: #444;
    }
    .note-content a {
      color: var(--accent);
      text-decoration: none;
      border-bottom: 1px solid rgba(244,132,95,0.4);
      padding-bottom: 1px;
    }
    .note-content a:hover {
      color: var(--green);
      border-color: var(--green);
    }
    .note-content ul,
    .note-content ol {
      margin: 0.5rem 0 0.5rem 1.4rem;
      color: #444;
    }
    .note-content li {
      margin: 0.25rem 0;
    }
    .note-content img {
      margin: 0.6rem auto;
      border-radius: 10px;
    }

    /* Related experiences at bottom */
    .related-exps {
      margin-top: 2rem;
      padding-top: 1.2rem;
      border-top: 1px solid #F0ECE2;
    }
    .related-title {
      font-size: 0.98rem;
      font-weight: 700;
      color: var(--green);
      margin-bottom: 0.6rem;
    }
    .related-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.9rem;
    }
    .related-card {
      display: flex;
      flex-direction: column;
      background: #FDFBF7;
      border-radius: 12px;
      border: 1px solid #E5DECF;
      overflow: hidden;
      text-decoration: none;
      color: var(--green);
      box-shadow: 0 2px 8px rgba(0,0,0,0.02);
      transition: all 0.2s;
    }
    .related-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 18px rgba(45,106,79,0.12);
      border-color: var(--accent-soft);
    }
    .related-thumb-wrap {
      position: relative;
      width: 100%;
      padding-top: 58%;
      background: #ddd;
      overflow: hidden;
    }
    .related-thumb-wrap img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }
    .related-card:hover .related-thumb-wrap img {
      transform: scale(1.04);
    }
    .related-body {
      padding: 0.6rem 0.7rem 0.7rem;
      display: flex;
      flex-direction: column;
      gap: 0.18rem;
    }
    .related-title-zh {
      font-size: 0.92rem;
      font-weight: 700;
      line-height: 1.4;
      color: var(--green);
    }
    .related-title-en {
      font-size: 0.78rem;
      color: #4a7b60;
    }
    .related-desc {
      font-size: 0.78rem;
      color: #666;
      line-height: 1.4;
      margin-top: 0.1rem;
    }
    .related-more {
      margin-top: 0.2rem;
      font-size: 0.76rem;
      font-weight: 700;
      color: var(--accent);
    }

    /* 進場動畫 */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(26px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      opacity: 0;
      transform: translateY(26px);
      transition: all 0.7s ease;
    }
    .fade-in.visible {
      opacity: 1;
      transform: translateY(0);
    }

    @media (max-width: 768px) {
      .hero-note {
        padding: calc(2.6rem + var(--header-height)) 1.25rem 1.6rem;
      }
      .hero-title {
        font-size: 1.7rem;
      }
      .note-wrapper {
        padding: 1.6rem 1.25rem 2.4rem;
      }
      .note-card {
        padding: 1.3rem 1.1rem 1.6rem;
      }
      .note-cover {
        margin: -1.3rem -1.1rem 1rem;
        max-height: 260px;
      }
      .related-grid {
        grid-template-columns: 1fr;
      }
      .back-to-top {
        right: 16px;
        bottom: 16px;
        width: 48px;
        height: 48px;
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="brand">
      <a href="index.html">
        <div class="brand-en">LOCAL FRIENDS TAIWAN</div>
        <div class="brand-zh">台灣在地連線</div>
      </a>
    </div>
    <nav class="main-nav" id="mainNav">
      <a href="experiences.html"><span class="en">Experiences</span><span class="zh">體驗列表</span></a>
      <a href="about.html"><span class="en">About</span><span class="zh">關於我們</span></a>
      <a href="faq.html"><span class="en">FAQ</span><span class="zh">常見問題</span></a>
      <a href="hosts.html"><span class="en">For Hosts</span><span class="zh">成為在地朋友</span></a>
      <a href="notes.html" class="active"><span class="en">Trail Notes</span><span class="zh">探路筆記</span></a>
      <a href="contact.html"><span class="en">Contact</span><span class="zh">聯繫我們</span></a>
    </nav>
    <button class="nav-toggle" id="navToggle" aria-label="切換導覽選單">☰</button>
  </header>

  <!-- Back to top -->
  <button class="back-to-top" onclick="scrollToTop()">↑</button>

  <!-- Hero -->
  <section class="hero-note fade-in">
    <div class="hero-inner">
      <div class="hero-kicker">TRAIL NOTES · 探路筆記</div>
      <h1 id="noteTitle" class="hero-title">Loading…</h1>
      <div id="noteTitleZh" class="hero-subtitle-zh" style="display:none;"></div>
      <div id="noteMeta" class="hero-meta"></div>
      <div class="hero-back">
        <a href="notes.html">← Back to Trail Notes 返回探路筆記列表</a>
      </div>
    </div>
  </section>

  <!-- Note Content -->
  <main class="note-wrapper">
    <section class="note-card fade-in">
      <div id="coverWrap" class="note-cover" style="display:none;">
        <img id="noteCover" src="" alt="">
      </div>

      <div class="note-badge-row" id="badgeRow" style="display:none;"></div>

      <article id="noteContent" class="note-content">
        Loading content…
      </article>

      <div id="noteError" class="note-error" style="display:none;"></div>

      <!-- Related experiences at bottom -->
      <div id="relatedExpsWrapper" class="related-exps" style="display:none;">
        <div class="related-title">Related experiences 對應體驗</div>
        <div id="relatedGrid" class="related-grid"></div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="footer" style="background:linear-gradient(135deg,#2D6A4F,#40916C);color:#fff;text-align:center;padding:2.4rem 2rem;">
    <p style="font-size:1.2rem;margin-bottom:0.6rem;"><strong>Local Friends Taiwan 台灣在地連線</strong></p>
    <p>Your local friend in Taiwan | 當你需要一位台灣在地的朋友</p>
    <p style="margin-top:1.2rem;opacity:0.9;font-size:0.95rem;">
      © 2025 Local Friends Taiwan. Independent Information Platform.
    </p>
  </footer>

  <script>
    const NOTES_SHEET_ID = '1icnZhegrhiUdaWz_BgQK0CQ_oueDhPhZgnl3opy9PJs';
    const NOTES_SHEET_URL = `https://docs.google.com/spreadsheets/d/${NOTES_SHEET_ID}/gviz/tq?tqx=out:csv`;

    const EXP_SHEET_ID = '1GD4gg3sGIfX7KGrJkYCL10wzvwZh5FMWQPGd9NVTQyc';
    const EXP_SHEET_URL = `https://docs.google.com/spreadsheets/d/${EXP_SHEET_ID}/gviz/tq?tqx=out:csv`;

    document.addEventListener('DOMContentLoaded', () => {
      // Nav toggle (mobile)
      const navToggle = document.getElementById('navToggle');
      const mainNav = document.getElementById('mainNav');
      if (navToggle && mainNav) {
        navToggle.addEventListener('click', () => {
          const isOpen = mainNav.classList.toggle('open');
          navToggle.classList.toggle('open', isOpen);
        });
        mainNav.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
            if (mainNav.classList.contains('open')) {
              mainNav.classList.remove('open');
              navToggle.classList.remove('open');
            }
          });
        });
      }

      setupFadeIn();
      initNoteDetail();
    });

    function setupFadeIn() {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) entry.target.classList.add('visible');
        });
      }, { threshold: 0.12, rootMargin: '0px 0px -60px 0px' });

      document.querySelectorAll('.fade-in').forEach((el, i) => {
        el.style.transitionDelay = `${i * 0.06}s`;
        observer.observe(el);
      });
    }

    async function initNoteDetail() {
      const params = new URLSearchParams(window.location.search);
      const id = (params.get('id') || '').trim();

      const noteTitleEl = document.getElementById('noteTitle');
      const noteTitleZhEl = document.getElementById('noteTitleZh');
      const noteMetaEl = document.getElementById('noteMeta');
      const noteContentEl = document.getElementById('noteContent');
      const noteErrorEl = document.getElementById('noteError');
      const coverWrap = document.getElementById('coverWrap');
      const coverImg = document.getElementById('noteCover');
      const badgeRow = document.getElementById('badgeRow');

      if (!id) {
        noteTitleEl.textContent = 'Note not found';
        noteContentEl.textContent = 'Missing note ID. Please go back to Trail Notes.';
        return;
      }

      try {
        const resp = await fetch(NOTES_SHEET_URL);
        const csv = await resp.text();
        const rows = parseCSV(csv);
        const headers = rows[0];
        const data = rows.slice(1);

        const notes = data.map(r => {
          const o = {};
          headers.forEach((h, i) => o[h.trim()] = (r[i] || '').trim());
          return o;
        });

        const note = notes.find(n => {
          const nid = (n['ID'] || n['id'] || '').trim();
          return nid && nid === id;
        });

        if (!note) {
          noteTitleEl.textContent = 'Note not found';
          noteContentEl.textContent = '找不到這篇探路筆記，請回到列表頁重新選擇。';
          return;
        }

        if (!isNotePublished(note)) {
          noteTitleEl.textContent = 'Note not available';
          noteContentEl.textContent = '這篇探路筆記目前尚未公開或已下架。';
          return;
        }

        const titleEn = note['Title_en'] || note['Title EN'] || note['Title'] || '';
        const titleZh = note['Title_zh'] || note['Title ZH'] || note['標題'] || '';
        const type = note['Type'] || note['類型'] || '';
        const date = note['Date'] || note['日期'] || '';
        const cover = (note['Cover'] || note['Cover Image'] || '').trim();
        const docUrlRaw = (note['Doc_URL'] || note['Doc URL'] || note['DocUrl'] || note['Doc'] || '').trim();
        const tagsRaw = note['Tags'] || '';
        const relatedRaw = note['Related_experience_id'] || note['Related_experience_ID'] || '';

        // Hero title & subtitle
        noteTitleEl.textContent = titleEn || titleZh || 'Trail Note';
        if (titleZh) {
          noteTitleZhEl.style.display = 'block';
          noteTitleZhEl.textContent = titleZh;
        }

        // Meta
        const metaParts = [];
        if (type) metaParts.push(type);
        if (date) metaParts.push(date);
        noteMetaEl.textContent = metaParts.join(' ・ ');

        // Badges (type + tags)
        const badges = [];
        if (type) badges.push(type);
        if (tagsRaw) {
          tagsRaw.split(/[,\s、]+/)
            .map(t => t.trim())
            .filter(Boolean)
            .forEach(t => badges.push(t));
        }
        if (badges.length) {
          badgeRow.style.display = 'flex';
          badgeRow.innerHTML = badges
            .map(t => `<span class="note-badge">${t}</span>`)
            .join('');
        }

        // Cover
        if (cover) {
          coverWrap.style.display = 'block';
          coverImg.src = cover;
          coverImg.alt = titleEn || titleZh || 'Trail Notes cover';
          coverImg.onerror = () => { coverWrap.style.display = 'none'; };
        }

        // Load Google Doc content
        if (docUrlRaw) {
          const docUrl = buildDocEmbedUrl(docUrlRaw);
          try {
            const docResp = await fetch(docUrl);
            const docHtml = await docResp.text();
            const cleaned = extractDocBody(docHtml);
            noteContentEl.innerHTML = cleaned || '（目前尚無詳細內容）';
          } catch (e) {
            console.error(e);
            noteContentEl.textContent = '無法載入詳細內容，請稍後再試，或直接查看原始連結。';
            noteErrorEl.style.display = 'block';
            noteErrorEl.innerHTML = `<a href="${docUrlRaw}" target="_blank" rel="noopener">開啟原始筆記（Google Doc）</a>`;
          }
        } else {
          noteContentEl.textContent = '（此筆記尚未連結完整內容）';
        }

        // Related experiences (bottom cards)
        const relatedIds = relatedRaw
          ? relatedRaw.split(/[,\s、]+/).map(x => x.trim()).filter(Boolean)
          : [];
        if (relatedIds.length) {
          await loadRelatedExperiences(relatedIds);
        }

      } catch (err) {
        console.error(err);
        noteTitleEl.textContent = 'Error loading note';
        noteContentEl.textContent = '';
        noteErrorEl.style.display = 'block';
        noteErrorEl.textContent = '⚠️ 無法載入探路筆記，請稍後再試或返回列表頁。';
      }
    }

    async function loadRelatedExperiences(relatedIds) {
      const wrapper = document.getElementById('relatedExpsWrapper');
      const grid = document.getElementById('relatedGrid');
      if (!wrapper || !grid || !relatedIds || !relatedIds.length) return;

      try {
        const resp = await fetch(EXP_SHEET_URL);
        const csv = await resp.text();
        const rows = parseCSV(csv);
        const headers = rows[0];
        const data = rows.slice(1);

        const exps = data.map(r => {
          const o = {};
          headers.forEach((h, i) => o[h.trim()] = (r[i] || '').trim());
          return o;
        }).filter(isExpPublished);

        const uniqueIds = Array.from(new Set(relatedIds));
        const matched = uniqueIds
          .map(id => exps.find(exp => (exp['ID'] || '').trim() === id))
          .filter(Boolean);

        if (!matched.length) return;

        grid.innerHTML = matched.map(exp => {
          const id = (exp['ID'] || '').trim();
          const href = id ? `experience-detail.html?id=${encodeURIComponent(id)}` : '#';

          const nameZh = (exp['體驗名稱(中)'] || '').trim();
          const nameEn = (exp['體驗名稱(英)'] || '').trim();
          const line = (exp['一句話描述(中)'] || exp['一句話描述(英)'] || '').trim();

          const cover = getExpCover(exp);

          return `
            <a class="related-card" href="${href}">
              <div class="related-thumb-wrap">
                ${cover
                  ? `<img src="${cover}" alt="${nameZh || nameEn || 'experience cover'}"
                           onerror="this.style.display='none';this.parentElement.style.background='#e5e5e5';">`
                  : ``}
              </div>
              <div class="related-body">
                <div class="related-title-zh">${nameZh || '未命名體驗'}</div>
                ${nameEn ? `<div class="related-title-en">${nameEn}</div>` : ``}
                ${line ? `<div class="related-desc">${line}</div>` : ``}
                <div class="related-more">View details 查看體驗詳情 →</div>
              </div>
            </a>
          `;
        }).join('');

        wrapper.style.display = 'block';
      } catch (err) {
        console.error('Failed to load related experiences', err);
      }
    }

    function parseCSV(csv) {
      const lines = csv.split('\n').filter(l => l.trim().length > 0);
      return lines.map(line => {
        const values = [];
        let cur = '';
        let inQ = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          if (ch === '"') {
            if (inQ && line[i + 1] === '"') {
              cur += '"';
              i++;
            } else {
              inQ = !inQ;
            }
          } else if (ch === ',' && !inQ) {
            values.push(cur);
            cur = '';
          } else {
            cur += ch;
          }
        }
        values.push(cur);
        return values.map(v => v.trim());
      });
    }

    function isNotePublished(note) {
      const raw = (note['Status'] || note['status'] || '').trim().toLowerCase();
      if (!raw) return false;
      return (
        raw === '已發佈' ||
        raw === '已發布' ||
        raw === 'published' ||
        raw === 'publish'
      );
    }

    function isExpPublished(o) {
      const raw = (o['Status'] || o['status'] || '').trim().toLowerCase();
      if (!raw) return false;
      return (
        raw === '已發佈' ||
        raw === '已發布' ||
        raw === 'published' ||
        raw === 'publish'
      );
    }

    function getExpCover(exp) {
      const raw = (exp['封面圖連結'] || exp['照片集'] || exp['圖片'] || '').replace(/，/g, ',');
      const links = raw.split(/[,\s]+/).map(s => s.trim()).filter(Boolean);
      return links[0] || '';
    }

    function buildDocEmbedUrl(url) {
      if (/\/pub(\?|$)/.test(url) || /embedded=true/.test(url)) return url;
      const m = url.match(/\/document\/d\/([a-zA-Z0-9_-]+)/);
      if (m && m[1]) {
        return `https://docs.google.com/document/d/${m[1]}/pub?embedded=true`;
      }
      return url;
    }

    function extractDocBody(html) {
      try {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        let node = doc.querySelector('#contents') || doc.querySelector('.doc-content') || doc.body;

        if (!node) return '';

        node.querySelectorAll('script,style').forEach(el => el.remove());

        node.querySelectorAll('*').forEach(el => {
          el.removeAttribute('style');
          el.removeAttribute('id');
          el.removeAttribute('class');
        });

        return node.innerHTML.trim();
      } catch (e) {
        console.error(e);
        return '';
      }
    }

    // Back to top
    window.addEventListener('scroll', () => {
      const b = document.querySelector('.back-to-top');
      if (!b) return;
      if (window.pageYOffset > 300) b.classList.add('show');
      else b.classList.remove('show');
    });
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  </script>
</body>
</html>
