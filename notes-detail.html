<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trail Note - Local Friends Taiwan</title>
  <meta name="description" content="Trail Notes detail from Local Friends Taiwan.">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;}

    :root{
      --header-height:56px;
      --max-width:900px;
      --green:#2D6A4F;
      --bg:#F7F5F2;
      --accent:#F4845F;
      --accent-soft:#E9C46A;
    }

    html,body{overflow-x:hidden;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Microsoft JhengHei",sans-serif;
      line-height:1.7;
      color:var(--green);
      background:var(--bg);
      -webkit-font-smoothing:antialiased;
      word-break:keep-all;
      overflow-wrap:anywhere;
    }
    h1,h2,h3{text-wrap:balance;}
    img,video{max-width:100%;height:auto;display:block;}

    /* Header */
    .site-header{
      position:fixed;top:0;left:0;right:0;
      height:var(--header-height);
      padding:0 1.5rem;
      display:flex;align-items:center;gap:1.25rem;
      background:rgba(247,245,242,.98);
      backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(45,106,79,.06);
      z-index:1100;
    }
    .brand{display:flex;flex-direction:column;line-height:1.2;}
    .brand a{text-decoration:none;color:var(--green);}
    .brand-en{font-weight:700;letter-spacing:.11em;font-size:.78rem;}
    .brand-zh{opacity:.9;font-size:.78rem;}

    .main-nav{margin-left:auto;display:flex;align-items:center;gap:.5rem;}
    .main-nav a{
      display:inline-flex;align-items:center;justify-content:center;
      padding:.4rem .9rem;border-radius:999px;
      border:1.4px solid transparent;
      font-size:.86rem;font-weight:700;
      color:var(--green);text-decoration:none;white-space:nowrap;
      transition:all .18s;
    }
    .main-nav a span.en{margin-right:.18rem;}
    .main-nav a:hover,.main-nav a.active{
      border-color:var(--accent-soft);
      background:#FFF7EB;
      box-shadow:0 2px 8px rgba(233,196,106,.25);
      transform:translateY(-1px);
    }

    .nav-toggle{
      display:none;margin-left:auto;width:34px;height:34px;
      border-radius:999px;border:1.4px solid var(--green);
      background:transparent;color:var(--green);
      font-size:1.2rem;cursor:pointer;
      align-items:center;justify-content:center;
      transition:all .2s;
    }
    .nav-toggle:hover{background:#E9C46A22;}
    .nav-toggle.open{
      background:var(--green);color:#F7F5F2;border-color:var(--green);
    }

    @media(max-width:768px){
      .site-header{padding:0 1rem;}
      .brand-en,.brand-zh{font-size:.74rem;}
      .main-nav{
        position:fixed;top:var(--header-height);left:0;right:0;
        padding:.45rem .85rem .55rem;
        background:rgba(247,245,242,.98);
        backdrop-filter:blur(10px);
        border-bottom:1px solid rgba(45,106,79,.08);
        display:none;flex-wrap:nowrap;gap:.45rem;
        overflow-x:auto;white-space:nowrap;z-index:1090;
      }
      .main-nav.open{display:flex;}
      .main-nav::-webkit-scrollbar{height:3px;}
      .main-nav::-webkit-scrollbar-thumb{
        background:rgba(233,196,106,.9);border-radius:999px;
      }
      .main-nav a{
        padding:.35rem .8rem;font-size:.8rem;
        box-shadow:0 1px 4px rgba(0,0,0,.04);
      }
      .nav-toggle{display:inline-flex;}
    }

    /* Back to top */
    .back-to-top{
      position:fixed;right:30px;bottom:30px;
      width:60px;height:60px;border-radius:50%;
      border:none;background:linear-gradient(135deg,#F4845F,#F4A261);
      color:#fff;font-size:1.5rem;cursor:pointer;
      box-shadow:0 4px 20px rgba(244,132,95,.4);
      display:none;z-index:1000;transition:transform .3s;
    }
    .back-to-top:hover{transform:translateY(-5px);}
    .back-to-top.show{
      display:flex;align-items:center;justify-content:center;
      animation:fadeInUp .5s ease;
    }

    /* Hero / meta */
    .hero{
      padding:calc(var(--header-height)+1.8rem) 1.5rem 0.8rem;
      background:#fff;
      border-bottom:1px solid rgba(0,0,0,.04);
    }
    .hero-inner{
      max-width:var(--max-width);
      margin:0 auto;
    }
    .back-link{
      font-size:.8rem;
      color:#6b8f7a;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:.2rem;
      margin-bottom:.4rem;
    }
    .back-link:hover{color:var(--accent);}
    .note-type{
      font-size:.78rem;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#999;
      margin-bottom:.2rem;
    }
    .note-title{
      font-size:2rem;
      font-weight:800;
      color:var(--green);
      margin-bottom:.1rem;
    }
    .note-meta{
      font-size:.82rem;
      color:#7d8f83;
      margin-bottom:.4rem;
    }
    .note-tags{
      display:flex;flex-wrap:wrap;
      gap:.25rem;margin-bottom:.6rem;
    }
    .note-tag{
      padding:.18rem .55rem;
      border-radius:999px;
      border:1px solid #E9C46A;
      background:#FFFBF2;
      font-size:.7rem;
      color:#6b7b70;
    }

    /* Cover */
    .cover-wrap{
      max-width:var(--max-width);
      margin:0.3rem auto 0.8rem;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 4px 18px rgba(0,0,0,.06);
    }
    .cover-wrap img{
      width:100%;
      height:auto;
      display:block;
      object-fit:cover;
    }

    /* Content */
    .content-section{
      max-width:var(--max-width);
      margin:0 auto 3rem;
      padding:1.5rem;
      background:#fff;
      border-radius:14px;
      border:1px solid #E5DECF;
      box-shadow:0 4px 16px rgba(0,0,0,.03);
    }
    .content-section .loading-line{
      height:10px;
      margin:.4rem 0;
      border-radius:6px;
      background:linear-gradient(90deg,#e9f3ee,#f3faf7,#e9f3ee);
      background-size:200% 100%;
      animation:shimmer 1.2s infinite;
    }
    @keyframes shimmer{
      0%{background-position:0 0;}
      100%{background-position:200% 0;}
    }

    .doc-body h1,
    .doc-body h2,
    .doc-body h3,
    .doc-body h4{
      margin:1.4rem 0 .6rem;
      font-weight:800;
      color:#1f4d39;
      line-height:1.3;
    }
    .doc-body p{
      margin:.6rem 0;
      color:#333;
      font-size:.98rem;
    }
    .doc-body strong{font-weight:700;}
    .doc-body ul,
    .doc-body ol{
      margin:.5rem 0 .5rem 1.3rem;
      font-size:.95rem;
      color:#333;
    }
    .doc-body li{margin:.25rem 0;}
    .doc-body blockquote{
      margin:1rem 0;
      padding:.7rem .9rem;
      border-left:4px solid #E9C46A;
      background:#FFF9E6;
      border-radius:8px;
      color:#555;
      font-size:.9rem;
    }
    .doc-body img{
      max-width:100% !important;
      height:auto !important;
      display:block;
      margin:1rem auto;
      border-radius:10px;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }
    .doc-body figure{
      max-width:100%;
      margin:1rem 0;
    }
    .doc-body table{
      border-collapse:collapse;
      width:100%;
      margin:0;
    }
    .doc-body th,
    .doc-body td{
      border:1px solid #e6e6e6;
      padding:.45rem .6rem;
      font-size:.88rem;
      text-align:left;
      vertical-align:top;
    }
    .doc-body thead th{
      background:#f7f7f7;
      font-weight:700;
    }
    .table-wrap{
      width:100%;
      overflow-x:auto;
      margin:1rem 0;
    }
    .table-wrap::-webkit-scrollbar{height:4px;}
    .table-wrap::-webkit-scrollbar-thumb{
      background:rgba(233,196,106,.9);
      border-radius:999px;
    }
    .doc-body iframe{
      max-width:100% !important;
      width:100% !important;
      border:0;
      border-radius:10px;
      min-height:260px;
      box-shadow:0 2px 12px rgba(0,0,0,.06);
    }

    .footer{
      background:linear-gradient(135deg,#2D6A4F,#40916C);
      color:#fff;
      text-align:center;
      padding:2.4rem 2rem;
    }
    .footer p{margin:.15rem 0;}
    .footer a{color:#fff;text-decoration:none;font-weight:700;}
    .footer a:hover{text-decoration:underline;}

    @keyframes fadeInUp{
      from{opacity:0;transform:translateY(18px);}
      to{opacity:1;transform:translateY(0);}
    }

    @media(max-width:768px){
      .hero{
        padding:calc(var(--header-height)+1.4rem) 1rem .6rem;
      }
      .note-title{font-size:1.6rem;}
      .content-section{
        margin:0.4rem auto 2.2rem;
        padding:1.25rem 1rem 1.4rem;
      }
      .back-to-top{
        right:16px;bottom:16px;
        width:48px;height:48px;font-size:1.2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="brand">
      <a href="index.html">
        <div class="brand-en">LOCAL FRIENDS TAIWAN</div>
        <div class="brand-zh">台灣在地連線</div>
      </a>
    </div>
    <nav class="main-nav" id="mainNav">
      <a href="experiences.html"><span class="en">Experiences</span><span class="zh">體驗列表</span></a>
      <a href="about.html"><span class="en">About</span><span class="zh">關於我們</span></a>
      <a href="faq.html"><span class="en">FAQ</span><span class="zh">常見問題</span></a>
      <a href="hosts.html"><span class="en">For Hosts</span><span class="zh">成為在地朋友</span></a>
      <a href="notes.html" class="active"><span class="en">Trail Notes</span><span class="zh">探路筆記</span></a>
      <a href="contact.html"><span class="en">Contact</span><span class="zh">聯繫我們</span></a>
    </nav>
    <button class="nav-toggle" id="navToggle" aria-label="切換導覽選單">☰</button>
  </header>

  <!-- Back to top -->
  <button class="back-to-top" onclick="scrollToTop()">↑</button>

  <!-- Hero / meta -->
  <section class="hero">
    <div class="hero-inner">
      <a href="notes.html" class="back-link">← Back to Trail Notes 返回列表</a>
      <div id="noteType" class="note-type"></div>
      <h1 id="noteTitle" class="note-title">Loading...</h1>
      <div id="noteMeta" class="note-meta"></div>
      <div id="noteTags" class="note-tags"></div>
    </div>
  </section>

  <!-- Cover -->
  <div id="coverWrap" class="cover-wrap" style="display:none;">
    <img id="coverImg" src="" alt="Trail Note cover">
  </div>

  <!-- Content -->
  <main class="content-section">
    <div id="docBody" class="doc-body">
      <div class="loading-line" style="width:60%;"></div>
      <div class="loading-line" style="width:80%;"></div>
      <div class="loading-line" style="width:40%;"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p style="font-size:1.2rem;margin-bottom:0.6rem;"><strong>Local Friends Taiwan 台灣在地連線</strong></p>
    <p>Your local friend in Taiwan | 當你需要一位台灣在地的朋友</p>
    <p style="margin-top:1.2rem;opacity:0.9;font-size:0.95rem;">
      © 2025 Local Friends Taiwan. Independent Information Platform.
    </p>
  </footer>

  <script>
    const SHEET_ID = '1icnZhegrhiUdaWz_BgQK0CQ_oueDhPhZgnl3opy9PJs';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;

    document.addEventListener('DOMContentLoaded', () => {
      // Nav toggle
      const navToggle = document.getElementById('navToggle');
      const mainNav = document.getElementById('mainNav');
      if (navToggle && mainNav) {
        navToggle.addEventListener('click', () => {
          const isOpen = mainNav.classList.toggle('open');
          navToggle.classList.toggle('open', isOpen);
        });
        mainNav.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
            if (mainNav.classList.contains('open')) {
              mainNav.classList.remove('open');
              navToggle.classList.remove('open');
            }
          });
        });
      }

      loadNoteDetail();
    });

    async function loadNoteDetail() {
      const params = new URLSearchParams(window.location.search);
      const id = (params.get('id') || '').trim();
      const docBody = document.getElementById('docBody');

      if (!id) {
        document.getElementById('noteTitle').textContent = 'Note not found';
        docBody.innerHTML = '<p>找不到指定的探路筆記 ID。</p>';
        return;
      }

      try {
        const resp = await fetch(SHEET_URL);
        const txt = await resp.text();
        const rows = parseCSV(txt);
        const headers = rows[0] || [];
        const data = rows.slice(1);

        const list = data.map(r => {
          const o = {};
          headers.forEach((h,i)=>o[h.trim()] = (r[i] || '').trim());
          return o;
        });

        const note = list.find(o => {
          const status = (o['Status'] || o['status'] || o['狀態'] || '').trim();
          const noteId = (o['ID'] || o['Id'] || o['id'] || '').trim();
          return status === '已發佈' && noteId === id;
        });

        if (!note) {
          document.getElementById('noteTitle').textContent = 'Note not found';
          docBody.innerHTML = '<p>找不到這篇探路筆記，或尚未公開。</p>';
          return;
        }

        renderMeta(note);
        await renderDoc(note);
      } catch (err) {
        console.error(err);
        document.getElementById('noteTitle').textContent = 'Error loading';
        docBody.innerHTML = '<p>⚠️ 無法載入內容，請稍後再試。</p>';
      }
    }

    function parseCSV(csv){
      const lines = csv.split('\n');
      return lines.map(line => {
        const values=[]; let cur=''; let inQ=false;
        for(const ch of line){
          if(ch === '"'){ inQ = !inQ; }
          else if(ch === ',' && !inQ){
            values.push(cur);
            cur = '';
          }else{
            cur += ch;
          }
        }
        values.push(cur);
        return values;
      });
    }

    function renderMeta(note){
      const title = (note['Title'] || note['標題'] || '').trim() || 'Untitled Note';
      const type = (note['Type'] || note['類型'] || '').trim();
      const date = (note['Date'] || note['日期'] || '').trim();
      const tagsRaw = (note['Tags'] || note['標籤'] || '').trim();
      const cover = (note['Cover'] || note['封面'] || note['封面圖'] || '').trim();

      document.title = `${title} - Trail Notes | Local Friends Taiwan`;
      document.getElementById('noteTitle').textContent = title;
      document.getElementById('noteType').textContent = type ? type.toUpperCase() : 'TRAIL NOTE';
      document.getElementById('noteMeta').textContent = [
        date || '',
        note['Location'] || note['地點'] || ''
      ].filter(Boolean).join(' · ');

      const tagsEl = document.getElementById('noteTags');
      tagsEl.innerHTML = '';
      if (tagsRaw) {
        tagsRaw.split(/[、,\s]+/).filter(Boolean).forEach(t => {
          const span = document.createElement('span');
          span.className = 'note-tag';
          span.textContent = t;
          tagsEl.appendChild(span);
        });
      }

      if (cover) {
        const wrap = document.getElementById('coverWrap');
        const img = document.getElementById('coverImg');
        img.src = cover;
        img.onload = () => { wrap.style.display = 'block'; };
        img.onerror = () => { wrap.style.display = 'none'; };
      }
    }

    async function renderDoc(note){
      const docBody = document.getElementById('docBody');
      docBody.innerHTML = `
        <div class="loading-line" style="width:60%;"></div>
        <div class="loading-line" style="width:80%;"></div>
        <div class="loading-line" style="width:40%;"></div>
      `;

      const raw = (note['Doc'] || note['Google Doc'] || note['Doc Link'] || note['內容連結'] || '').trim();
      if (!raw) {
        docBody.innerHTML = '<p>（此篇尚未連結完整內容，稍後將更新。）</p>';
        return;
      }

      const fetchURL = toFetchableDocURL(raw);

      try {
        const resp = await fetch(fetchURL, { mode:'cors' });
        const html = await resp.text();

        const tmp = document.createElement('div');
        tmp.innerHTML = html;

        let main = tmp.querySelector('#contents') || tmp.querySelector('body') || tmp;

        // 移除不必要元素
        main.querySelectorAll('script,style,header,nav,footer,meta,link').forEach(n => n.remove());

        // 包一層，方便處理
        const wrapper = document.createElement('div');
        wrapper.innerHTML = main.innerHTML;

        // 處理圖片
        wrapper.querySelectorAll('img').forEach(img => {
          img.removeAttribute('width');
          img.removeAttribute('height');
          img.loading = 'lazy';
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          img.style.display = 'block';
          img.style.margin = '1rem auto';
          img.style.borderRadius = '10px';
          img.style.boxShadow = '0 2px 12px rgba(0,0,0,.06)';
          img.onerror = () => {
            img.style.display = 'none';
          };
        });

        // 處理表格：加外層可橫向捲動
        wrapper.querySelectorAll('table').forEach(t => {
          const w = document.createElement('div');
          w.className = 'table-wrap';
          t.parentNode.insertBefore(w, t);
          w.appendChild(t);
        });

        // iframe 寬度
        wrapper.querySelectorAll('iframe').forEach(f => {
          f.removeAttribute('width');
          f.style.width = '100%';
        });

        docBody.innerHTML = '';
        docBody.appendChild(wrapper);
      } catch (err) {
        console.warn('Doc fetch blocked, fallback iframe', err);
        docBody.innerHTML = `
          <p style="font-size:.9rem;color:#666;margin-bottom:.5rem;">
            內容由公開的 Google Doc 載入，如無法正常顯示，請直接於新分頁開啟：
            <a href="${raw}" target="_blank" rel="noopener" style="color:${'#F4845F'};">點這裡查看全文</a>
          </p>
          <iframe src="${toEmbeddableIframeURL(raw)}"></iframe>
        `;
      }
    }

    function toFetchableDocURL(url){
      if (/\/document\/d\/e\/[^/]+\/pub/.test(url)) {
        return url.includes('?') ? url : url + '?embedded=true';
      }
      const m = url.match(/\/document\/d\/([^/]+)/);
      if (m) {
        const id = m[1];
        return `https://docs.google.com/document/d/${id}/export?format=html`;
      }
      return url;
    }

    function toEmbeddableIframeURL(url){
      if (/\/document\/d\/e\/[^/]+\/pub/.test(url)) {
        return url.includes('?') ? url + '&embedded=true' : url + '?embedded=true';
      }
      const m = url.match(/\/document\/d\/([^/]+)/);
      if (m) {
        const id = m[1];
        return `https://docs.google.com/document/d/${id}/preview?rm=minimal&embedded=true`;
      }
      return url;
    }

    // Back to top
    window.addEventListener('scroll', () => {
      const b = document.querySelector('.back-to-top');
      if (!b) return;
      if (window.pageYOffset > 300) b.classList.add('show');
      else b.classList.remove('show');
    });
    function scrollToTop(){
      window.scrollTo({top:0,behavior:'smooth'});
    }
  </script>
</body>
</html>
